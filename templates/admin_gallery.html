<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Gallery - KC4CA Image Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}">
    <style>
        .filter-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .filter-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 10px;
        }
        
        .pagination a {
            padding: 8px 12px;
            background-color: #4a6fa5;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .pagination a:hover {
            background-color: #3a5a80;
        }
        
        .pagination .current {
            background-color: #3a5a80;
            font-weight: bold;
        }
        
        .image-stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .delete-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Admin Gallery</h1>
            <p>Manage all generated images</p>
        </header>

        <main>
            <section class="filter-section">
                <h2>Filters</h2>
                <form class="filter-form" method="GET">
                    <!-- Preserve password parameter -->
                    <input type="hidden" name="password" value="{{ request.args.get('password') }}">
                    
                    <div class="filter-group">
                        <label for="session_id">Session ID:</label>
                        <select id="session_id" name="session_id">
                            <option value="">All Sessions</option>
                            {% for sid in session_id_list %}
                                <option value="{{ sid }}" {% if session_id == sid %}selected{% endif %}>{{ sid[:8] }}...</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="prompt">Prompt:</label>
                        <input type="text" id="prompt" name="prompt" value="{{ prompt }}" placeholder="Filter by prompt">
                    </div>
                    
                    <div class="filter-group">
                        <label for="model">Model:</label>
                        <select id="model" name="model">
                            <option value="">All Models</option>
                            {% for m in model_list %}
                                <option value="{{ m }}" {% if model == m %}selected{% endif %}>{{ m }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="per_page">Items per page:</label>
                        <select id="per_page" name="per_page">
                            <option value="20" {% if request.args.get('per_page', 20) == 20 %}selected{% endif %}>20</option>
                            <option value="50" {% if request.args.get('per_page') == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if request.args.get('per_page') == 100 %}selected{% endif %}>100</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button type="submit">Filter</button>
                    </div>
                </form>
            </section>

            <section class="images-section">
                <div class="image-stats">
                    <p>Total images: {{ total_count }} | Page {{ current_page }} of {{ total_pages }}</p>
                </div>
                
                <div class="images-container">
                    {% if images %}
                        {% for image in images %}
                        <div class="image-card">
                            <div class="thumbnail-container">
                                <img src="{{ image.thumbnail_path }}" alt="{{ image.prompt }}" class="thumbnail" data-fullsize="{{ image.image_path }}">
                            </div>
                            <div class="image-info">
                                <p><strong>Prompt:</strong> {{ image.prompt[:50] }}{% if image.prompt|length > 50 %}...{% endif %}</p>
                                <p><strong>Session:</strong> {{ image.session_id[:8] }}</p>
                                <p><strong>Model:</strong> {{ image.model }}</p>
                                <p><strong>Size:</strong> {{ image.size }}</p>
                                <p><strong>Quality:</strong> {{ image.quality }}</p>
                                <p><strong>Generated:</strong> {{ image.timestamp }}</p>
                                <button class="delete-btn" data-image-id="{{ image.id }}">Delete</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p>No images found.</p>
                    {% endif %}
                </div>
                
                {% if total_pages > 1 %}
                <div class="pagination">
                    {% if current_page > 1 %}
                        <a href="?page=1&session_id={{ session_id }}&prompt={{ prompt }}&model={{ model }}&per_page={{ request.args.get('per_page', 20) }}&password={{ request.args.get('password') }}">&laquo; First</a>
                        <a href="?page={{ current_page - 1 }}&session_id={{ session_id }}&prompt={{ prompt }}&model={{ model }}&per_page={{ request.args.get('per_page', 20) }}&password={{ request.args.get('password') }}">Previous</a>
                    {% endif %}
                    
                    {% for i in range(1, total_pages + 1) %}
                        {% if i == current_page %}
                            <span class="current">{{ i }}</span>
                        {% elif i >= current_page - 2 and i <= current_page + 2 %}
                            <a href="?page={{ i }}&session_id={{ session_id }}&prompt={{ prompt }}&model={{ model }}&per_page={{ request.args.get('per_page', 20) }}&password={{ request.args.get('password') }}">{{ i }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if current_page < total_pages %}
                        <a href="?page={{ current_page + 1 }}&session_id={{ session_id }}&prompt={{ prompt }}&model={{ model }}&per_page={{ request.args.get('per_page', 20) }}&password={{ request.args.get('password') }}">Next</a>
                        <a href="?page={{ total_pages }}&session_id={{ session_id }}&prompt={{ prompt }}&model={{ model }}&per_page={{ request.args.get('per_page', 20) }}&password={{ request.args.get('password') }}">Last &raquo;</a>
                    {% endif %}
                </div>
                {% endif %}
            </section>
        </main>

        <footer>
            <p>&copy; 2025 KC4CA Image Generator - Admin Gallery</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add click event listeners to thumbnails
            const thumbnails = document.querySelectorAll('.thumbnail');
            thumbnails.forEach(thumbnail => {
                thumbnail.addEventListener('click', function() {
                    const fullSizeUrl = this.getAttribute('data-fullsize');
                    showFullSizeImage(fullSizeUrl);
                });
            });
            
            // Add click event listeners to delete buttons
            const deleteButtons = document.querySelectorAll('.delete-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const imageId = this.getAttribute('data-image-id');
                    if (confirm('Are you sure you want to delete this image?')) {
                        deleteImage(imageId);
                    }
                });
            });
            
            // Function to show full-size image in a modal
            function showFullSizeImage(imageUrl) {
                // Create modal elements
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close">&times;</span>
                        <img src="${imageUrl}" alt="Full size image" class="full-size-image">
                        <div class="modal-actions">
                            <button id="download-btn">Download Image</button>
                        </div>
                    </div>
                `;
                
                // Add modal to document
                document.body.appendChild(modal);
                
                // Add event listeners
                const closeBtn = modal.querySelector('.close');
                const downloadBtn = modal.querySelector('#download-btn');
                
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
                
                downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.href = imageUrl;
                    link.download = imageUrl.split('/').pop();
                    link.click();
                });
                
                // Close modal when clicking outside the content
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });
            }
            
            // Function to delete an image
            function deleteImage(imageId) {
                // Get the password from the URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const password = urlParams.get('password');
                
                fetch(`/admin/delete_image/${imageId}?password=${password}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Image deleted successfully');
                        // Reload the page to show updated gallery
                        location.reload();
                    } else {
                        alert('Error deleting image: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the image');
                });
            }
        });
    </script>
</body>
</html>
